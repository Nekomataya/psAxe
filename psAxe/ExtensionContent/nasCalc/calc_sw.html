<html><head>
	<meta http-equiv="Content-Type" content="text/html; charset=euc-JP">
<title>ねこまた電卓</title>
	
<!-- LINK REL="stylesheet" TYPE="text/css" href="./dougubako.css" -->
<script src=../common_files/nas_common.js></script>
<script language="JavaScript">
<!--
/*
ねこまたや の電卓
 電卓
 ストップウオッチ その3つづき
Javascriptに移植してみるですよ。 2004/03/15 kiyo/Nekomataya

2004/03/20 ちょっと修正
ラップ表示エレメントとMaxLapの記述が違っていたら
MaxLapを減らしてエラーがでないようにした。
ラップ表示の初期値をヌルから0に変更


2004/04/13 ほつれ直し
いろいろ不具合修正。ラップ表示は正常になったかな？

2004・09・12	電卓と合体
2004/09/18	game.gr.jp のライブラリを借りて組み込む
2004/09/26	タイムコードくみこむどぉ
2004/10/12	再開、タイムコード組み込み中
2005/01/17	また持って再開 TCつづき
2005/01/22	電卓の仕様に合わせてラップメモリを変更
2005/04/17	タイムコードからフレーム数を返す関数修正
		25フレーム時のパラメータエラー
		100fpsの判定ミス

このプログラムの著作権は「ねこまたや」にあります。

あなたは、このプログラムのこの著作権表示を改変しないかぎり
自由にプログラムの使用・複製・再配布などを行うことができます。

あなたは、このプログラムを自己の目的にしたがって改造することができます。
その場合、このプログラムを改造したものであることを明記して、この著作権表示を
添付するように努めてください。

このプログラムを使うも使わないもあなたの自由なのです。

ただし、作者はこのプログラムを使用したことによって起きたいかなる
不利益に対しても責任を負いません。
あなたは、あなたの判断と責任においてこのプログラムを使用するのです。

なんか、困ったことがあったら以下で連絡してもらえると何とかなるかもしれません。
http://homepage2.nifty.com/Nekomata/
mailto:nekomata_ya@mac.com

そんな感じです。
*/

//	変数初期化
var VER="05041701";

/*	初期状態の設定
初期状態は、呼び出し側に記述された値で上書きするので
こちらを特に変更する必要はなさそう。
*/
//	時計の設定
var ccrate	=1000;		//最少計測単位(javascriptではミリ秒固定)
var MODE	="clock";	//表示の初期モード(時計)
var KeyMODE	="calculator";	//キー入力の初期モード(電卓)
var ClockOption	=12;		//時計の初期モード (12時制)
var STATUS	="stop";
//	計測モード
//ここの並びでループする	100fps 24FPS 30NDF 30DF 25FPS
RATEs = ["100fps","24FPS","30NDF","30DF","25FPS"];
var RATE	="24FPS";
var FRATE	=24.;
var frate	=24.;
//	マウスクリックでアクションするかどうかのフラグ
var m_action	=true 		; 
//	ログ配列を初期化
Log	=new Array();
function nas_Push_Log(str) {Log = Log.concat([str])}
//	ログ 初期化してみる
nas_Push_Log( "Program Started " + VER);
nas_Push_Log( Date() );
nas_Push_Log( "     FrameRate" + frate + "(" + RATE + ")");
nas_Push_Log( "     Start Mode      [" + MODE + "]" );
//ラップの最大保持数をここに記入
MaxLap = 0;
//	ラップ用のメモリを初期化

function nas_Clear_LAP() {
var checkMX=MaxLap;
	LAP = new Array(MaxLap);
	LapName = new Array(MaxLap);
		for(i = 0; i < MaxLap; i++){
			LapName[i] = "lap" + i;
			LAP[i] = nas_FR2TC(0)[1] ;
// ラップ表示欄は、きちんとラップメモリの数だけ作ってね。
// でないとラップを減らしちゃうよ。
try {
	document.nasCALC.elements[LapName[ i ]].value = LAP[i];
	var VoiD = document.nasCALC.elements[LapName[i]].value;
} catch(eRR) {
	checkMX= i + 1 ;	
	nas_Push_Log("\tcheck " + LapName[i] +" "+ eRR);
	nas_Push_Log(VoiD);
}
			} 
	MaxLap = checkMX;
	nas_Push_Log("\tLap memory clear");
 }
//	nas_Clear_LAP(MaxLap);
//	時間関連オブジェクトの初期化
ClockClicks = new Date();

var Start = 0;
var Stop = 0;

var nas_display = "";
//ランニングインジケータ設定
Ri = new Array(24) ;
var running = "";
function initRi(_base){
	for (n = 0; n < 25; n++) {
	Ri[n] = _base.substring(0,n + 1) + "|" + _base.substring(n + 2,26)
	}
	running = Ri[0];
}
/*	電卓部分の各変数を初期化	*/
var key_off=0;//キーボード入力フラグ
// カウンタの初期値
//10: 00000 ./20: 0:00:00 ./30: 000 + 00 ./40: p 1 / 0 + 00 ./50: p 1 / + 000 .
//11: 00001 _/21: 0:00:01 _/31: 000 + 01 _/41: p 1 / 0 + 01 _/51: p 1 / + 001 _
//var FCTo0 = 10;
//var FCTo1 = 31;
//var eFRM = 1 ;
var fctOpt = 20;//タイムコード計算の表示形式
var CALCmode=1;
var dEbug=0;
var inBuf='0';//入力バッファ、文字列で扱うこと
var siBuf='0';//サブ入力バッファ

//電卓のスタック
//スタックにメソッドとして push pop dup を登録
function s_dup()
{
	this[this.length]=this[this.length-1];
}
function s_push(n)
{
	this[this.length]=n;
}
function s_pop()
{
	if (this.length > 0)
	{
		result=this[this.length - 1];
		delete this[this.length-1];
		this.length --;
	} else {
		result='';
	}
	return result;
}
function s_exc()
{
	if (this.length > 1)
	{
		var bkup_u=this[this.length-1];
		delete this[this.length-1];
		this.length --;
		var bkup_d=this[this.length-1];
		delete this[this.length-1];
		this.length --;
	this[this.length]=bkup_u;
	this[this.length]=bkup_d;
	}
	return ;
}
function s_top()
{
	if (this.length > 0)
	{
		result=this[this.length - 1];
	} else {
		result='';
	}
	return result;
}
var operandStack = new Array();
operandStack.pop = s_pop ;
operandStack.push = s_push ;
operandStack.dup = s_dup ;
operandStack.exc = s_exc ;
operandStack.top = s_top ;

operandStack.push(0);
var newStack=0;//スタック内容確定のフラグ
var comBuf='';//オペレータバッファ
var maxPlace=12;//電卓としての最大桁数?
var bufPlace=1;//現在の入力バッファ桁数・初期値0 なので 最少は1桁
var bufDecimalPlace = 0;//入力バッファ小数部桁数
var checkRegex = /[0-9\.]+/ ;
//演算モード変数
var INPUTmode='dec'//bin,oct,dec,hex,frame,tc,sk,
var TCf=0;//TCフラグ
var OPf=0;//
var prefix = '';
var cardinal = 10;
var checkRegex = /^[0-9]$/;
//chgINPUTmode('dec');

/*
	ユーザエージェントを確認してフラグを返す
	判定基準はユーザエージェント文字列
*/
function ckUA(){
//許可リスト
//ここにユーザエージェント文字列を記載したエージェントは拒否リストに載らないかぎりフラグを立てて返す。エントリは、ユーザエージェント文字列すべて。
agentsAllow=['Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)','Mozilla/5.0 (Macintosh; U; PPC Mac OS X; ja-jp) AppleWebKit/412 (KHTML, like Gecko) Safari/412','void'];
//拒否リスト 最優先に処理
agentsDeny=['Mozilla/4.0 (compatible; MSIE 5.23; Mac_PowerPC)','void'];
//標準的なエージェントとバージョン 指定値以上を許可
	var ckvs=new Array();
		ckvs['MSIE']=5.5;
		ckvs['Opera']=7;
		ckvs['Safari']=150;
		ckvs['NN']=6.0;
		ckvs['Mozilla']=5.0;//その他のモジラ
	var agentFlag=-1;//初期値 判別不能時に初期値を返す
	var uaName = navigator.userAgent;//ユーザエージェント文字列を取得
	var uaVer = '';
	if (uaName.indexOf("Safari") > -1) {
		uaVer = uaName.match(/(Safari\/)([0-9\.]*)/)[2];
//		ver = new Array();
//		ver["85"] = "1.0";ver["100"] = "1.1";
//		ver["125"] = "1.2";ver["412"] = "2.0";
		n = uaVer.split(".")[0];uaVer = 1 * n ;
		uaName = "Safari";//サファリらしい
	}else{
		if (uaName.indexOf("Opera") > -1) {
		uaVer = uaName.match(/(Opera[\ \/])([0-9\.]*)/)[2]
		uaName = "Opera";//オペラである
		}else{
			if (uaName.indexOf("MSIE") > -1) {
		uaVer = uaName.match(/(MSIE[\ \/])([0-9\.]*)/)[2];
		uaName = 'MSIE'
			}else{
				if (uaName.indexOf("Netscape") > -1) {
		uaVer = uaName.match(/(Netscape6?[\ \/])([0-9\.]*)/)[2];
		uaVer = (uaVer.split("\.")[0]*1)+(uaVer.split("\.")[1]/10)
		uaName = "NN";//NSにしてみる。
				}else{
			if (uaName.indexOf("Mozilla") > -1) {
		uaVer = uaName.match(/(Mozilla[\ \/])([0-9\.]*)/)[2];
		uaName = "Mozilla";//NSでないMozillaにしてみる。
			}else{
		uaVer = 'unKnown';
		uaName = 'unKnown';//知らないブラウザである。
		}}}}}
	if (! uaName.match(/unKnown/)){
//ブラウザ名とバージョンから判定をとる
		if (uaVer >=ckvs[uaName]){
			agentFlag=1;//大丈夫;
		}else{
			agentFlag=0;//ダメダメ;
		}
	}
//	確認ブラウザか?
	for (aGent in agentsAllow) {
	if (agentsAllow[aGent] == navigator.userAgent){agentFlag=1;break;}
	}
//	確認否定ブラウザか?
	for (aGent in agentsDeny) {
	if (agentsDeny[aGent] == navigator.userAgent){agentFlag=0;break}
	}
return [agentFlag,uaName,uaVer];
}
/*
game.gr.jp のライブラリ
*/

/*/////////////// 押されたキ−コード取得用関数   UseFree
========================================================
 Win  n4 n6 moz e4 e5 e6,
 Mac  n4 n6 moz e4.5 e5,
 Linux n4 n6 moz         
========================================================
 押されたキ−コードを取得します。
 キ−の文を取得したい場合は、getKEYSTR(e)を
 参照してください

 使用例  //押されたキ−コードをダイアログに表示する
  alert( getKEYCODE(e) )

 Support http://game.gr.jp/js/
=======================================================*/

  //--ブラウザを調べてNNとIEの分岐を微調整します
  MSIE = navigator.userAgent.indexOf("MSIE")!=-1 

  //--押されたキ−コードを返す
  function getKEYCODE(e){  

      if(document.all)           return  event.keyCode
      else if(document.getElementById) 
            return (e.keyCode!=0)?e.keyCode:e.charCode
      else if(document.layers)   return  e.which
  }


//--修飾キーのための処理
//イベントを渡して CTRL/ALT/SHIFT 各キーの状態をチェック
function chkCtrl(e){ 

      if(document.getElementById && !MSIE )  
                                  return  e.ctrlKey
      else if(document.all)       return  event.ctrlKey
      else if(document.layers){
        var ctl=e.modifiers
        if( ctl==2 || ctl==3 || ctl==6 || ctl==7 ) 
             return  true
        else return  false
      }
}

function chkAlt(e){ 

      if(document.getElementById && !MSIE )  
                                  return  e.altKey
      else if(document.all)       return  event.altKey
      else if(document.layers){
        var ctl=e.modifiers
        if( ctl==1 || ctl==3 || ctl==5 || ctl==7 ) 
             return  true
        else return  false
      }
}

function chkShift(e){ 

      if(document.getElementById && !MSIE )  
                                  return  e.shiftKey
      else if(document.all)       return  event.shiftKey
      else if(document.layers){
        var ctl=e.modifiers
        if(  ctl==4 || ctl==5 || ctl==6 || ctl==7 ) 
             return  true
        else return  false
      }
}


/*///////////////////////////// HTML出力用関数   UseFree
========================================================
 Win  n4 n6 moz e4 e5 e6,
 Mac  n4 n6 moz e4.5 e5,
 Linux n4 n6 moz         
========================================================
  使用例
  outputLAYER('レイヤ−名',出力するHTML) 

 Support http://game.gr.jp/js/
=======================================================*/

  function outputLAYER(layName,html){

    if(document.getElementById){       //N6,Moz,IE5,IE6用
      document.getElementById(layName).innerHTML=html

    } else if(document.all){                      //IE4用
      document.all(layName).innerHTML=html

    } else if(document.layers) {                  //NN4用
       with(document.layers[layName].document){
         open()
         write(html)
         close()
      }
    }

  }

/*///////////////////////////// HTML出力用関数ここまで */

  //--キーeventをセットする

  document.onkeydown = nas_InputD ;
  document.onkeypress = nas_InputP ;
  if(document.layers)
                document.captureEvents(Event.KEYPRESS)
  self.focus()


/*
ストップウオッチの関数
*/
//	clock clicks の値から表示モード別に表示値を生成
function nas_cc2dp(cc) {
	if (MODE == "watch") {
		frms = nas_cc2FR( cc - Start );
		TC = nas_FR2TC( frms );
		f = TC[0][3];
	return TC[1] ;
	} else  {
		xNow = new Date();
		h = xNow.getHours();
		m = xNow.getMinutes();
		s = xNow.getSeconds();
		switch (ClockOption) {
case "12":
	if(h <=11) {tf="AM"} else {h = h -12; tf="PM"};
clockdisplay =  nas_Zfill(h,2)+ ":" + nas_Zfill(m,2) + ":" + nas_Zfill(s,2) + " " + tf;
	break;
default:
clockdisplay = ".  " + nas_Zfill(h,2)+ ":" + nas_Zfill(m,2) + ":" + nas_Zfill(s,2) + "  ." 
		}
return clockdisplay
	}
}
//	end proc
/*
文字列を分割してTC文字列またはTC配列にして戻す
012345678 > 012:34:56:78,012,34,56,78
戻り値の形式は、nas_FR2TC()に準ずる。
TC=[h,m,s,f]
[TC,TCs]
*/
function nas_STR2TC(tcString){
//負の数ならフラグを立てて絶対値をとる
	var neG = 0;
	if (tcString<0){neG=1;tcString=Math.abs(tcString);alert("HitHitHit")}
//小数以下を捨てる
	tcString=Math.floor(tcString);
	var sepStr=":"//
	switch (RATE) {
case '30NDF':	sepStr=':';break;
case '30DF':	sepStr=';';break;
case '24FPS':	sepStr='+';break;
case '25FPS':	sepStr='-';break;
case '100fps':	sepStr='.';break;
default	:	sepStr=':';
	}
	tcString=nas_Zfill(tcString,8);//桁数不足を避けるためにゼロを加える。
	h =tcString.substr(0,tcString.length-6);
	m =tcString.substr(tcString.length-6,2);
	s =tcString.substr(tcString.length-4,2);
	f =tcString.substr(tcString.length-2,2);
TC = [h,m,s,f]
TCs = h+":"+m+":"+s+sepStr+f;
	if (neG){return nas_FR2TC(nas_TC2FR(TCs)*-1)[0][1];
	}else{
	return [TC,TCs];
	}
}
// end proc
/*
TCから、フレーム数を返す。
引数は 配列[h,m,s,f] または TC文字列
配列の場合は、現在のフレームレート識別変数を参照する。
文字列の場合は、ローカルに判定
hh:mm:ss:ff	30NDF
hh:mm:ss;ff	30DF
hh:mm:ss+ff	24FPS
hh:mm:ss-ff	25FPS
hh:mm:ss.ff	100fps
文字列の場合は、他の不定フレームレートを解釈しない。
その場合は、配列とフレームレートを外部参照できるようにすること
*/
function nas_TC2FR(TC) {
var rATE=RATE;
	if (TC.match(/^([0-9]*):?([0-9]*):?([0-9]*)([-;\+:\.]{1})([0-9]*)$/)) {
		var sTC=[0,0,0,0,];
		sTC=[RegExp.$1,RegExp.$2,RegExp.$3,RegExp.$5,''];
//配列の並び替えルーチンまだ
var idn=3;
var TC=[0,0,0,0];
for(idx=3;idx>=0;idx--){
	if (sTC[idx]==sTC[4]) { continue } else {TC[idn]=sTC[idx];idn--}
}
//alert(sTC[idx] + '=' + sTC[4])
		switch (RegExp.$4) {
case	':':	rATE='30NDF';break;
case	';':	rATE='30DF';break;
case	'+':	rATE='24FPS';break;
case	'-':	rATE='25FPS';break;
case	'.':	rATE='100fps';break;
default	:	rATE=RATE;
		}
//TC=sTC;
	} else {
//マッチしなかった場合、引数を返して終了
	return TC;
	}
//TCのフォーマットは [h,m,s,f] 配列にする
	h = 1*TC[0]; m = 1*TC[1]; s = 1*TC[2]; f = 1*TC[3];
switch(rATE) {
case "100fps":
	FR = h * 360000 + m * 6000 + s * 100 + f ; break;
case "24FPS":
	FR = h * 86400 + m * 1440 + s * 24 + f ; break;
case "30NDF":
	FR = h * 108000 + m * 1800 + s * 30 + f ; break;
case "30DF":
	FR = h * 107892 + (m / 10) * 17982  ;
	if((m % 10) != 0) {FR = FR + s * 30 + f} else {
		if(s) {
FR = FR + (m % 10) * 1800 - ((m % 10) - 1) * 2 + s * 28 + (s - 1) * 2 + f ;
		} else {
if(f <= 1) {f = f + 2 }
FR = FR + (m % 10) * 1800 - ((m % 10) - 1) * 2 + f - 2;
		}
	}
	break;
default :
	var TmpRate=(rATE=="25FPS")? 25 : rATE;//暫定
	FR = h * TmpRate * 3600 + m * TmpRate * 60 + s * TmpRate + f;
}
return FR }
//	end proc
/*
//	TC値からフレーム値を算出
function nas_TC2FR(TC) {
//TCのフォーマットは [h,m,s,f] 配列にする
	h = TC[0]; m = TC[1]; s = TC[2]; f = TC[3];
switch(RATE) {
case "100fps":
	FR = h * 360000 + m * 6000 + s * 100 + f ; break;
case "24FPS":
	FR = h * 86400 + m * 1440 + s * 24 + f ; break;
case "30NDF":
	FR = h * 108000 + m * 1800 + s * 30 + f ; break;
case "30DF"://ドロップフレーム処理
	FR = h * 107892 + (m / 10) * 17982  ;//時＋分
	if((m % 10) != 0) {
		FR = FR + s * 30 + f;//毎正分以外は30fで加算
	} else {
//それ以外はさらに分岐
		if(s) {
//
FR = FR + (m % 10) * 1800 - ((m % 10) - 1) * 2 + s * 28 + (s - 1) * 2 + f ;
		} else {
//
if(f <= 1) {f = f + 2 }
FR = FR + (m % 10) * 1800 - ((m % 10) - 1) * 2 + f - 2;
		}
	}
	break;
default :
	FR = h * RATE * 3600 + m * RATE * 60 + s * RATE + f
}
return FR }
//	end proc
*/
//	FR値からTC値を算出
function nas_FR2TC(FR) {
	if (FR<0){FR=(24*60*60*frate)-(Math.abs(FR)%(24*60*60*frate))}
	switch (RATE) {
case "100fps":
	h = Math.floor(FR / 360000) % 24;
	m = Math.floor(FR / 6000) % 60;
	s = Math.floor(FR / 100) % 60;
	f = Math.floor(FR) % 100;
TCs = nas_Zfill((h%24),2)+":"+nas_Zfill(m,2)+":"+nas_Zfill(s,2)+"."+nas_Zfill(f,2);
	break;
case "24FPS":
	h = Math.floor(FR / 86400) % 24;
	m = Math.floor(FR / 1440) % 60;
	s = Math.floor(FR / 24) % 60;
	f = Math.floor(FR) % 24;
TCs = nas_Zfill((h%24),2)+":"+nas_Zfill(m,2)+":"+nas_Zfill(s,2)+"+"+nas_Zfill(f,2);
	break;
case "30NDF":
	h =Math.floor(FR / 108000) % 24;
	m =Math.floor(FR / 1800) % 60;
	s =Math.floor(FR / 30) % 60;
	f =Math.floor(FR) % 30;
TCs = nas_Zfill((h%24),2)+":"+nas_Zfill(m,2)+":"+nas_Zfill(s,2)+":"+nas_Zfill(f,2);
	break;
case "30DF":
	h =Math.floor((FR / 107892) % 24);
	if(FR % 17982 < 1800) {
	m =Math.floor(((FR / 17982) % 6) * 10  + ((FR % 17982) / 1800))
	} else {
	m =Math.floor(((FR / 17982) % 6) * 10  + (((FR % 17982 ) - 2) / 1798))
	}
	s = Math.floor((((m % 10) * 2 + (FR / 17982) * 18 + FR) / 30) % 60);
	if ((m % 10) != 0) {
	f = Math.floor(((m % 10) * 2 + (FR / 17982 ) * 18 + FR) % 30)
	} else {
	if (s != 0) {
	f = Math.floor((((FR / 17982 ) * 18 + FR) % 30) + 2)
	} else {
	f = Math.floor(((m % 10) * 2 + (FR / 17982 ) * 18 + FR) % 30)
	}
	}
TCs = nas_Zfill((h%24),2)+":"+nas_Zfill(m,2)+":"+nas_Zfill(s,2)+";"+nas_Zfill(f,2);
	break;
default :
	h = Math.floor(FR / (frate * 3600)) % 24;
	m = Math.floor(FR / (frate * 60)) % 60;
	s = Math.floor(FR / frate) % 60;
	f = Math.floor(FR) % Math.floor(frate);
TCs = nas_Zfill((h%24),2)+":"+nas_Zfill(m,2)+":"+nas_Zfill(s,2)+"-"+nas_Zfill(f,2)
}
TC = [(h%24),m,s,f];
sTC =(h%24)*1000000+m*10000+s*100+f;
	return [TC,TCs,sTC.toString(10)];
}
//	end proc

//	cc値からFR値
function nas_cc2FR(cc) {
//global ccrate frate
	FR = Math.floor((frate * cc) / ccrate)
	return FR
}
//	end proc
//	FR値からcc値
function nas_FR2cc(FR) {return Math.floor((FR / frate) * ccrate)}
//	end proc
//	ゼロ埋め
function nas_Zfill(n,s) {if(n < Math.pow(10,(s - 1))) {
	rt = Math.pow(10,s) + n + "";
//document.nasCALC.sTatus.value = rt;
//return rt.substr(1,rt.length-1);
return rt.substr(rt.length-s,s);
} else {
return "" + n}}
//	終了
//	tclsh 互換リスト操作サブプロシージャ
//	lsearch(配列,検索値)
function nas_Alsearch(arr,ser) {for(n=0; n<arr.length; n++){if( arr[n] == ser ){ return n; break;}}}
//	フレームレート変更
function nas_ChangeRATE(newrate) {
	ClockClicks = new Date();
//	MODE = "watch";
//キャンセル用に変更前の値を退避
	cancel_Action = "ChangeRATE";oldrate = RATE;
//TCモードならばスタックの内容を時間に変換して保存(挿入)

switch(newrate) {
case "next":
newrate = RATEs[ nas_Alsearch(["25FPS","100fps","24FPS","30NDF","30DF"],pastrate) ];
break;
case "24FPS":
case "25FPS":
case "100fps":
case "30NDF":
case "30DF":	newrate=newrate;break;
default:
A = isNaN(newrate);
if(A == true) {newrate = "100fps"} else {
if(newrate <=0) {newrate = "100fps"} else {if(newrate >= 101) {newrate = "100fps"} else {newrate = newrate}}}
}
	switch(newrate) {
case "100fps":	frate = 100.	; RATE = newrate; pastrate = RATE; break;
case "24FPS":	frate = 24.	; RATE = newrate; pastrate = RATE; break;
case "30NDF":	frate = 30.	; RATE = newrate; pastrate = RATE; break;
case "30DF":	frate = 29.97	; RATE = newrate; pastrate = RATE; break;
case "25FPS":	frate = 25.	; RATE = newrate; pastrate = RATE; break;
default:	frate = newrate ; RATE = newrate + "fps";
	}
	FRATE = frate ;//暫定同期
	switch(STATUS) {
case "stop": document.nasCALC.nas_display.value = nas_FR2TC(nas_cc2FR(Stop - Start))[1]; break;
case "run\-lap": break;
case "run": document.nasCALC.nas_display.value = nas_cc2dp(ClockClicks.getTime()) ; break;
default :
	}
//TCモードの場合はスタックの内容を新しいフレームレートで更新(挿入)
	document.nasCALC.nas_RATE.value = RATE;
	nas_Push_Log("Change RATE\t"+ newrate )
	nas_Push_Log("Change frate\t"+ frate )
	updateDP();//電卓ディスプレイの更新
}
//	end proc

function nas_ChangeKBD(newmode) {
	switch(newmode) {
case "calculator":
case "stopwatch":
	KeyMODE = newmode; break;
default:
	KeyMODE = ['stopwatch','calculator'][nas_Alsearch(['calculator','stopwatch'],KeyMODE)];
	}
//	document.nasCALC.CHG.value=KeyMODE;
	switch(KeyMODE) {
case "calculator":
	m_action=false ;
	nas_Push_Log("Change Mode calculator");
//	document.nasCALC.CHG.src="./images/02.gif";
	document.getElementById("CHG").src="./images/02.gif";
		break;
case "stopwatch":
	m_action=true ;
	nas_Push_Log("Change Mode stopwatch");
//	document.nasCALC.CHG.src="./images/01.gif";
	document.getElementById("CHG").src="./images/01.gif";
		break;
default: nas_Push_Log('error nas_ChangeKBD()');

	}
return false;}
//	end proc
function nas_ChangeMODE(newmode) {
	switch(newmode) {
case "clock":
case "watch":
	MODE = newmode; break;
default:
	MODE = ['watch','clock'][nas_Alsearch(['clock','watch'],MODE)];
	}
	switch(MODE) {
case "clock":
//	m_action=false ;
	nas_Push_Log("Change Mode Clock");
//	document.nasCALC.CHG_clock.value="CLOCK";

	document.getElementById("CHG_clock").src="./images/04.gif";

//	document.nasCALC.CHG_clock.src="./images/04.gif";
//alert("hear?")//try{}catch(e){alert(e)}
		break;
case "watch":
//	m_action=false ;
	nas_Push_Log("Change Mode Stop-Watch");
//	document.nasCALC.CHG_clock.value="WATCH";
//	document.nasCALC.CHG_clock.src="./images/03.gif";
	document.getElementById("CHG_clock").src="./images/03.gif";
		break;
default: nas_Push_Log('error nas_ChangeMODE()');

	}
return false;}
//	end proc
//表示用インターバルプロシージャ
function nas_update_View() {
	ClockClicks = new Date();
frms = Math.floor((ClockClicks.getTime() - Start) / (ccrate / frate));
	TC = nas_FR2TC(frms);
	f = TC[0][3];
		switch(MODE) {
case "clock": nas_display = nas_cc2dp(0);
	if(nas_display != document.nasCALC.nas_display.value) {
	document.nasCALC.nas_display.value = nas_display}
	break;
case "watch":
	switch(STATUS) {
case "stop":
	nas_display = nas_FR2TC(nas_cc2FR(Stop - Start))[1];
	if(nas_display != document.nasCALC.nas_display.value) {
document.nasCALC.nas_display.value = nas_display}
	break;
case "run":
if(TC[1] != document.nasCALC.nas_display.value ) {
	document.nasCALC.nas_display.value = TC[1]}
	 break;

default:
	}
		}

	switch(STATUS) {
case "run\-lap":	;
case "run":
running = Ri[Math.floor(24 * (f / frate))];
if(running != document.nasCALC.nas_Ri.value) {document.nasCALC.nas_Ri.value = running }
break;
default:
	}
}
//	end proc
function nas_push_LAP(cc) {
//	TCの場合 
//	for(n = MaxLap - 1 ;n > 0 ;n-- ) {LAP[n] = LAP[n - 1]}
//	LAP[0] = nas_FR2TC(nas_cc2FR(cc - Start))[1];
//	document.nasCALC.nas_display.value = LAP[0];
	var LAP = nas_FR2TC(nas_cc2FR(cc - Start))[1];
	document.nasCALC.nas_display.value = LAP;
//	for(n = 0 ; n < MaxLap ;n++) {document.nasCALC.elements["lap"+ n ].value = LAP[n]}
//コンソールが開いているときだけラップを表示
	if(UImode["cons"]>0)	{putsCONS(LAP)}
//	LOG
	switch(STATUS) {
case "stop":    PreFix ="Stop"; break;
case "run":     ;
case "run\-lap":	PreFix ="Lap"; break;
default :       PreFix =""
	}
	nas_Push_Log(PreFix + "\t" + LAP)
}
//	end proc
//	スタートとストップ引数なし
function nas_Start_Stop() {
//呼出元にしたがって 基準時刻の選択 ダメならとりあえず現在時刻をとる
switch (nas_capt) {
case "Key"	:now = ct_K; break;
case "Object"	:now = ct_O; break;
case "Mouse"	:now = ct_M; break;
default:
ClockClicks = new Date(); now =ClockClicks.getTime()
}

	switch(STATUS) {
case "stop":    Start = now - (Stop - Start);
		if(Stop != 0) {nas_push_LAP(now)} else {nas_Push_Log("Start")}
		STATUS ="run"; break;
case "run":     nas_cc2dp(now);
		Stop = now;
		STATUS = "stop"; break;
case "run\-lap":STATUS = "run"; break;
	}
	switch(MODE) {
case "clock":
nas_ChangeMODE('watch');break;
default : 
	}
document.nasCALC.sTatus.value = STATUS
}
//	end proc
function nas_Lap_Reset() {

//呼出元にしたがって 基準時刻の選択 ダメならとりあえず現在時刻をとる
switch (nas_capt) {
case "Key"	:now = ct_K; break;
case "Object"	:now = ct_O; break;
case "Mouse"	:now = ct_M; break;
default:
ClockClicks = new Date(); now =ClockClicks.getTime()
}
	switch(STATUS) {
case "stop":    nas_cc2dp(Start);
		if(Stop != 0) {nas_push_LAP(Stop)}
		Start = 0 ; Stop = 0 ; nas_Push_Log("\treset\n");
		running = Ri[0];
		document.nasCALC.nas_Ri.value = running;
		document.nasCALC.sTatus.value = "ready";
		break;
case "run":     nas_push_LAP(now);
		STATUS = "run-lap";
		document.nasCALC.sTatus.value = STATUS;
		break;
case "run-lap": nas_cc2dp(now);
		nas_push_LAP(now);
	}
}
//	end proc
function nas_InputD(e) {
//キーダウンをキャプチャ
//何はなくとも現在時を保持
ClockClicks = new Date();ct_K = ClockClicks.getTime();nas_capt = "Key";
//putsCONS(getKEYCODE(e)+'/'+String.fromCharCode(getKEYCODE(e)));
//putsCONS(nas_cc2FR(ct_K)+"_");
	if ( KeyMODE == 'calculator' )
	{		return true;
	} else {

	key = getKEYCODE(e);//キーコードを取得
	switch(key) {
case 13 :       nas_Lap_Reset(); break;//enter
//case 27 :       nas_Clear_LAP(); break;//esc
case 32 :       nas_Start_Stop(); break;//space
case 49 :       nas_ChangeRATE("100fps"); break;//1
case 50 :       nas_ChangeRATE("24FPS"); break;//2
case 51 :       nas_ChangeRATE("30NDF"); break;//3
case 52 :       nas_ChangeRATE("30DF"); break;//4
case 53 :       nas_ChangeRATE("25FPS"); break;//5
case 65 :       about_nas(); break;//a
case 76 :       nas_write_Log(); break;//l
case 84 :       nas_ChangeMODE(); break;//T
//case 113 :	nas_ChangeKBD();break;//q 入力モード切り換え
default :       return false
	}
return false;
	}
}
//キープレスをキャプチャ
function nas_InputP(e) {
//何はなくとも現在時を保持
ClockClicks = new Date();ct_K = ClockClicks.getTime();nas_capt = "Key";
putsSTS(getKEYCODE(e)+'/'+String.fromCharCode(getKEYCODE(e)));
//putsCONS(nas_cc2FR(ct_K));
	if (key_off) return true;
//イベントを受け取る仕様に変更
	key = getKEYCODE(e);//キーコードを取得
	if ( KeyMODE == 'calculator' ) {
//putsCONS(key + ';')
//if (! document.nasCALC.SIbuf.focus()) return true;
	switch(key) {
case 9 :       ;//TAB
case 37 :       ;//left
case 38 :       ;//up
case 39 :       ;//right
case 40 :       ;//down
case 32 :       return true; break;//SPACE
case 8 :       pushKey('BS'); break;//bs
case 3 :       ;//enter(mac)
case 13 :       pushKey('='); break;//Return
case 27 :       pushKey('AC'); break;//esc
case 127 :       pushKey('CE'); break;//del
/*
144はnumlockだった
*/
case 86 :	pushKey('MOD');break;//>MOD
case 90 :	pushKey('delta');break;//>delta
case 109 :	pushKey('m2i');break;//>m2i
//case 109 :	if(TC){pushKey('m')}else{pushKey('m2i')};break;//>m2i
case 105 :	pushKey('i2m');break;//>i2m
case 77 :	qpimp(operandStack.top(),'mm');break;//M>mm
case 73 :	qpimp(operandStack.top(),'in');break;//I>inch
case 80 :	qpimp(operandStack.top(),'pt');break;//P>point
case 81 :	qpimp(operandStack.top(),'Q');break;//Q>Q
case 112 :	qpimp(operandStack.top(),'px');break;//p>pixel
// case 113 :	nas_ChangeKBD('stopwatch');break;//入力モード切り換え

//case  :	pushKey('');break;//
default :// String.fromCharCode(getKEYCODE(e)) 等価である
	pushKey(String.fromCharCode(key));
	}
return false ;
	}
//
return true ;
}
//	end proc
//マウスボタンのキャプチャ
function nas_Mouse(Bt,Ob) {
ClockClicks = new Date();ct_M = ClockClicks.getTime();nas_capt = "Mouse"
if (KeyMODE != 'stopwatch') return false;
//	alert(navigator.appName);
//IEのとき event.button event.srcElement と入れ換える
if( navigator.appName == "Microsoft Internet Explorer" ) { Ob = event.srcElement.type ;Bt = event.button ;
// for IE
switch(Ob) {
case "text":	;
case "":	;
case "button":	m_action = false ;break ;
default:	m_action = true
}
 } else {
// for NN
if( Ob == "[object HTMLFormElement]") {m_action = true} else {m_action = false}
}
if( m_action != false) {
	switch(Bt) {
case 4: ;
case 2: ;
case 3:	nas_Lap_Reset(); break;
default:nas_Start_Stop()
	}
} else {return false }
}
//	end proc
/*	汎用のアクションキャプチャ
 呼び出しタイムラグを最少にする必要のある場合は、以下の書式でこの関数を呼び出します。
	nas_Capt("機能名称") 
 必要な引数は、受け渡し用の変数を別に立てて あらかじめ値を入力する必要あり。
 (ただし今のところべつになし)
 ここにある時間関連コマンド以外の関数は、直接呼び出す。
*/
function nas_Capt(Action_Name){
ClockClicks = new Date();ct_O = ClockClicks.getTime();nas_capt = "Object";
CaptureAction = Action_Name ;

	switch(Action_Name) {
case "Lap_Reset"	: nas_Lap_Reset(); break;
//case "Clear_LAP"	: nas_Clear_LAP(); break;
case "Start_Stop"	: nas_Start_Stop(); break;
default	: return false
	} 
}
// end function

//ログの表示 コンソールを開いて書き出す。
function nas_write_Log(){
	document.nasCALC.CONS.value='';
	for(l=0; l<Log.length;l ++){putsCONS(Log[l])}
/*
	LW1=window.open("","LW","width=320");
	LW1.document.open();
	LW1.document.write("<HTML><HEAD><TITLE>StopWatch-Log</TITLE></HEAD><BODY>");
	LW1.document.write("<PRE>");
	for(l=0; l<Log.length;l ++){LW1.document.write(Log[l]+"\n")}
	LW1.document.write("</PRE>");
	LW1.document.write("</BODY></HTML>");
//LW1.document.write();
//LW1.document.write();
LW1.document.close();
*/
}

//	end proc
//############### ABOUT Display
function about_nas(){
alert("Nekomataya Animation System \(Unsupported\) \n電卓+StopWatch "+ VER + "\n2005/04/17\n http://homepage2.nifty.com/Nekomata/")
}
/*
電卓部分
*/

//コンソールにメッセージ表示
function putsCONS(string){
//コンソールが表示されていない場合は表示する。
	if(UImode["cons"]==0){
		UImode["cons"]=UImode["fkb"]+UImode["nkb"]*2+1
	document.getElementById('consoleBox').innerHTML=
	UIdata['console0'+UImode["cons"]];
	}
//文字を表示する
	document.nasCALC.CONS.value += string +'\n';
}
//ステータス行にメッセージ表示
function putsSTS(string){
	window.status = string ;
}
// カウンタタイプの変更
function chgFCTopt() {
	fctOpt = document.nasCALC.FCTopt.value
//	FCTo1 = document.nasCALC.FCTo1.value
//	chgTC(0)
}

//二進数文字列から10進数
function bin2dec(bin) {
	var dec = 0;
	for (p=0;p<bin.length;p++){dec += bin.charAt(p) *  Math.pow(2,bin.length-p-1)};
	return dec
}
// 入力モード変更 モード名称は dec oct hex bin tcまたは next
function chgINPUTmode(mode) {
	if (mode == 'next'){
//	var MODEs=MODEs
	mode = ["dec","fct","oct","hex","bin"][nas_Alsearch(["fct","oct","hex","bin","dec"],INPUTmode)];
	}
	INPUTmode=mode;

switch (mode) {
case "fct":	checkRegex =/^[0-9]$/;prefix = ''	;cardinal =10;TCf=1;break;
case "bin":	checkRegex =/^[01]$/;prefix = ''	;cardinal =2;	break;
case "oct":	checkRegex =/^[0-7]$/;prefix = '0'	;cardinal =8;	break;
case "hex":	checkRegex =/^[0-9A-F]$/;prefix = '0x'	;cardinal =16;	break;
default:	checkRegex =/^[0-9]$/;prefix = ''	;cardinal =10;	break;
}
document.nasCALC.inputMode.value=
["10","TC","8","16","2"][nas_Alsearch(["dec","fct","oct","hex","bin"],INPUTmode)];
document.nasCALC.inputModeSelector.value=INPUTmode;
pushKey('=');
}

//解像度の変更
function chgResolution(vAlue){
	if (! isNaN(vAlue)) {
		if ( vAlue <= 0 || vAlue >= 12000) return;
	RESOLUTION=vAlue/2.540 ;
//RESOLUTION 派生変数
	Dpi = RESOLUTION * 2.540 ;
	Dpc = RESOLUTION ;

	document.nasCALC.Resolution.value=Math.floor(Dpi) + 'dpi';
}
}
//電卓バッファに対する直接入力の処理
function checkINbuf(){
			nas_Push_Log("INbuf check");
//テキストエリアの内容が評価可能ならば、評価してバッファに格納して復帰
	try {
		var eXp=eval(document.nasCALC.INbuf.value);
	} catch(eRR) {eXp="cannoteval";}
		if (! isNaN(eXp)) {
			nas_Push_Log("ok_eval");
			operandStack.pop();
			operandStack.push(eXp);
//	newStack=0;
			inBuf=eXp.toString();
		} else {
//評価に失敗した場合でも、TCモードの場合はTC文字列として再評価する
	if (document.nasCALC.INbuf.value.match(/^([0-9]*):?([0-9]*):?([0-9]*)([-;\+:]?)([0-9]*)$/)) {	eXp=nas_TC2FR(document.nasCALC.INbuf.value);
			nas_Push_Log("ok_TC");
			operandStack.pop();
			operandStack.push(eXp);
//		newStack=0;
			inBuf=eXp;
} else {

nas_Push_Log("ng");
}
		}
		document.nasCALC.INbuf.value = inBuf.toString(cardinal);
		pushKey("=");
	return;
}
function putsStack(){
	var resUlt="";
for (num=operandStack.length;num>0;num--){resUlt+=operandStack[num-1] +"\n"}
	document.nasCALC.RESULT.value=resUlt;
//	document.nasCALC.RESULT.value=operandStack;
}

//電卓のボタンを押す処理
function pushKey(button){
	if (button == '') return ;	//カラ呼び出しはリターン
	if (newStack && ! comBuf=='' &&button.match(checkRegex)){
//スタックが確定しているので、
//入力バッファを初期化して、新しいスタックをプッシュ
		inBuf='0';bufPlace=1;bufDecimalPlace=0;
if (dEbug){nas_Push_Log('StackPush');}
//		operandStack.pop();
		operandStack.push(0);
		newStack=0;	//スタック確定解除
	}
//入力可能な文字列だった場合は、バッファに追加
	if (button.match(checkRegex)) {
		if (bufPlace<maxPlace) {
	var oldDATA=inBuf+'/'+operandStack[operandStack.length -1];
			if (inBuf=='0') {
//ゼロのみの場合は入力でバッファを置き換え 桁数留保
				inBuf = button.toString(cardinal);
			}else{
//ゼロ以外の値ならば文字連結してバッファに格納 桁数は繰り上げ
				inBuf = inBuf + button;bufPlace ++ ;
			}
//小数フラグが立っていたら小数桁も切り上げ
			if (bufDecimalPlace>=1) bufDecimalPlace ++;
//電卓スタックとバッファを同期
			operandStack.pop();
switch (INPUTmode) {
case	"bin":	operandStack.push(bin2dec(inBuf));break	//bin
case	"fct":
		if (TCf) {
		operandStack.push(nas_TC2FR(nas_STR2TC(inBuf)[1]));	//TC
		}else{
		operandStack.push(eval(prefix + inBuf));	//TC保留
		}
		break;
default:	operandStack.push(eval(prefix + inBuf));
}
//ディスプレイ更新
	updateDP();
//デバッグ表示
if (dEbug){
	var newDATA=inBuf+'/'+operandStack[operandStack.length -1];
	putsSTS(newDATA);
	nas_Push_Log(oldDATA + ':'+newDATA+':'+bufPlace+':'+bufDecimalPlace);
}
		}else{
//NOP
//	updateDP();
		}

	} else {SW(button)}	
}
//	保留オペレータの解決(二項以上の演算子のみ) 
//	ここではスタックの更新のみで、表示はそのまま
function operatioN(){
if (operandStack.length==1) {newStack=0;return;}
	switch (comBuf){
	case		"-":	//減算
operandStack.push(- operandStack.pop() + operandStack.pop());break;
	case		"+":	//加算
operandStack.push(operandStack.pop() + operandStack.pop());break;
	case		"*":	//乗算
operandStack.push(operandStack.pop() * operandStack.pop());break;
	case		"/":	//実数商
operandStack.push((1/operandStack.pop()) * operandStack.pop());break;
	case		"MOD":	//剰余
var key=operandStack.pop();
operandStack.push(operandStack.pop()%key);break;
	case		"^":	//ベキ乗
var mulcount=operandStack.pop();
operandStack.push(Math.pow(operandStack.pop(),mulcount));

break;
	default:
nas_Push_Log('NOP');
;//NOP
	}
	newStack=1;	//スタックの確定フラグを立てる
}
//TC入力バッファスタック転送
//TCセパレータをキー入力しないことになったので、この関数は現在不使用 05/01/24
function ibEXst(Tkey){
	switch (Tkey) {
case	"h":	operandStack.push(operandStack.pop()+inBuf*60*60*frate);break;
case	"p":	operandStack.push(operandStack.pop()+inBuf*SheetLength);;break;
case	"m":	operandStack.push(operandStack.pop()+inBuf*60*frate);;break;
case	"s":	operandStack.push(operandStack.pop()+inBuf*frate);;break;
case	"k":	operandStack.push(operandStack.pop()+inBuf*1);;break;
case	"f":	operandStack.push(operandStack.pop()+inBuf*1);;break;
default	:	operandStack.pop();operandStack.push(inBuf*1);//無条件入れ換え
}
	inBuf='0';bufPlace=1;bufDecimalPlace=0;

}
//電卓表示部分の更新
function updateDP(){
if (INPUTmode=="fct") {
	if(TCf){
		document.nasCALC.INbuf.value = nas_STR2TC(inBuf)[1];
		document.nasCALC.SIbuf.value = '';
	}else{
		document.nasCALC.SIbuf.value = inBuf//保留中
	}
}else{
	document.nasCALC.INbuf.value = inBuf;
	document.nasCALC.SIbuf.value = '';
}
putsStack();//デバッグ用
}
//オペランド入力以外のコマンド処理
function SW(ComInput) {
if (dEbug) nas_Push_Log(ComInput + '\t>>');
//オペレータを受信したら

switch (ComInput) {
// 二項演算子
case		"*":	//乗算
case		"/":	//実数商
case		"MOD":	//剰余
case		"^":	//ベキ乗
case		"-":	//減算
case		"+":	//加算

//オペレータバッファが空ならば、バッファにオペレータを積むだけ
//それ以外は、以前の二項演算子を解決してから次のオペレータを積む
	if (! comBuf=='') {
//			operatioN();
			SW("=");
	}
//オペレータをオペレータバッファに置いてスタックの確定フラグを立る。
//表示更新
//TC入力フラグを調整
	comBuf = ComInput;
switch (ComInput) {
case	"*":	document.nasCALC.COMbuf.value = "×";	TCf=0;OPf=1;break;
case	"/":	document.nasCALC.COMbuf.value = "÷";	TCf=0;OPf=1;break;
case	"MOD":	document.nasCALC.COMbuf.value = "＼";	TCf=0;OPf=1;break;
case	"^":	document.nasCALC.COMbuf.value = "pow";	TCf=0;OPf=1;break;
case	"-":	document.nasCALC.COMbuf.value = "−";	TCf=1;OPf=1;break;
case	"+":	document.nasCALC.COMbuf.value = "＋";	TCf=1;OPf=1;break;
case	"":	document.nasCALC.COMbuf.value = "";	TCf=1;OPf=1;break;
case	"":	document.nasCALC.COMbuf.value = "";	TCf=1;OPf=1;break;
default:;
}
	newStack=1;
	return;
break;
// 単項演算子の処理
/*	kontoke形式は保留
case		"h"://入力バッファを時間としてスタックへ加算
case		"p"://入力バッファをページとしてスタックへ加算
case		"m"://入力バッファを分としてスタックへ加算
case		"s"://入力バッファを秒としてスタックへ加算
case		"k"://入力バッファをスタックへ加算
	if (TCf){ibEXst(ComInput);}
*/
case		"dup":	//メモリ?
	operandStack.dup();OPf=0;
break;
case		"pop":	//メモリ?
	operandStack.pop();OPf=0;
break;
case		"exc":	//メモリ?
	operandStack.exc();OPf=0;
break;
case		"R":	//√平方根
	operandStack.push(Math.sqrt(operandStack.pop()));OPf=0;
break;
case		"P":	//パイを入力
	operandStack.pop();//現スタックを廃棄
	operandStack.push(Math.PI);OPf=0;
break;
case		"T":	//符号反転
	operandStack.push(-(operandStack.pop()));OPf=0;
break;
case		"m2i":	//mm>インチ換算
	operandStack.push((operandStack.pop())/25.40);OPf=0;
break;
case		"i2m":	//インチ>mm換算
	operandStack.push(25.40*(operandStack.pop()));OPf=0;
break;
// 以下コマンド
case		"AC":	//オールクリア
	comBuf='';inBuf='0';
	while(operandStack.length) operandStack.pop() ;
	operandStack.pop() ;
	operandStack.push(0);
	bufDecimalPlace=0;
	bufPlace=1;
	newStack=0;
	OPf=1;

	document.nasCALC.CONS.value='';
	document.nasCALC.COMbuf.value = comBuf;
	updateDP();

//通常の表示更新をスキップしてリターン
	return;
break;
case		"CE":	//クリアエントリ
	operandStack.pop();
	operandStack.push(0);OPf=0;
break;
case		"BS":	//バックスペース(どうなの?コレ)
if (newStack) newStack=0;OPf=1;
if(bufPlace==1){
	inBuf = 0;
}else{
	if ( bufDecimalPlace == 2) {
	inBuf = inBuf.slice(0,inBuf.length-2);
		bufDecimalPlace =0 ;
	} else {
	inBuf = inBuf.slice(0,inBuf.length-1);
		if (bufDecimalPlace != 0 ) {
			bufDecimalPlace --;
		}
	}
	bufPlace --;
}
//
	operandStack.pop();
switch (INPUTmode) {
case	"bin":			operandStack.push(bin2dec(inBuf));break;//bin
case	"fct":
		if(TCf) {
		operandStack.push(nas_TC2FR(nas_STR2TC(inBuf)[1]));//TC
		}else{
		operandStack.push(eval(prefix + inBuf));//TC保留
		}
		break;
default:			operandStack.push(eval(prefix + inBuf));
}
	updateDP();
//通常の表示更新をスキップしてリターン
	return;
break;
case		"=":	//保留オペレータの解決
		operatioN();
		comBuf = '';//コマンドバッファのみ初期化
		document.nasCALC.COMbuf.value = comBuf;
//newStack=1;alert("newStack");
		TCf=1;OPf=1;
break;
case		".":	//小数フラグを立てる(小数以下桁数の変数と兼用)
	switch ( INPUTmode ){
case "dec":
	if (bufDecimalPlace==0){
	bufDecimalPlace = 1;
	inBuf=inBuf+'.';
	updateDP();
	}
	break;
case "fct":
//TCモードの場合単項演算子として使用する。(あとで)
	}
return;
break;
case		"STACK":	//スタック表示
	putsCONS(STACK);return;
break;
case		"check":	//デバッグ用に各変数表示
document.nasCALC.CONS.value = '';
	putsCONS('STACK\t: '+ operandStack+'\n'+'inBuf\t: '+ inBuf +' : '+bufPlace + '/' +bufDecimalPlace+'\nINPUTmode\t: '+INPUTmode+'\ncombuf\t: '+comBuf+'\nnstck\t: '+newStack+'\nTCf\t: '+TCf+'\n');return;
break;
case		":":	//
switch ( INPUTmode ){
case "fct":
//TCモードの場合単項演算子として使用する。(あとで)
//	inBuf=inBuf+':';
//	document.nasCALC.INbuf.value=inBuf;
	break;
default :
	;//NOP
}
return;
break;
//case		";":	//
//case		"-":	//
//case		"+":	//
//case		"":	//
//break;
default:	;//(NOP)
}
// コマンドの結果で表示を更新
if (dEbug) putsCONS( operandStack.top() );

//入力確定
// スタックトップの値を一時変数に取得
	var inBufvalue=operandStack.top() ;
//十進モード以外の場合は、整数にきり捨て
	if (! INPUTmode=="dec") inBufvalue=Math.floor(inBufvalue);
//バッファの内容を入力モード毎の文字列に変換してバッファ変数に格納
if (INPUTmode=="fct")	{
	inBuf=nas_FR2TC(inBufvalue.toString(cardinal))[2];//TC
		} else {
	inBuf=inBufvalue.toString(cardinal);//2~10進
		}
//でばぐ
if (dEbug){
putsCONS( ''  + Math.round( operandStack.top() * Math.pow(10,maxPlace) ) +'/'+ Math.pow(10,maxPlace) ) ;}
//
//ここで、バッファの内容から桁の値取得して変数に代入
	if (inBufvalue % 1 == 0){
//小数桁なし 負数でズレる・TCで分岐
		bufPlace=inBuf.length;
		bufDecimalPlace=0;
		slicePlace=0;
	}else{
//小数部あり
		bufPlace=inBufvalue.toString().length - 1;
		bufDecimalPlace=inBufvalue.toString().length - inBufvalue.toString().search(/\./);
		slicePlace=maxPlace-(bufPlace-bufDecimalPlace+1);
		if (slicePlace < 0) slicePlace=0;
	}
	if (inBuf<0) bufPlace --;

//桁溢れしている場合は、バッファの値を桁どおりに丸めて表示と置き換え
	if (bufPlace > maxPlace){
inBufvalue=Math.round( inBufvalue * Math.pow(10,slicePlace) )/Math.pow(10,slicePlace);
inBuf=inBufvalue.toString(cardinal);
	}
//現在の基数で表示
	updateDP();

// document.nasCALC.INbuf.value = inBuf ;
//最後に入力バッファの値を明示的に文字列に変換
	inBuf=inBuf.toString(cardinal);

}
//mipq+alpha
function qpimp(vAlue,uNit){
	if (INPUTmode == "fct"){
		document.nasCALC.CONS.value='';
		putsCONS("数値モードで使用してください。");
		return;
	}
var RESULT = '';
var rimPlace=10000;
	switch (uNit){
	case	'Q':
RESULT=
vAlue+'Q:\n'+
' ='+vAlue+' Q\n'+
' ='+Math.round((((0.25 * vAlue) / 25.40)*72)*rimPlace)/rimPlace+' pt\n'+
' ='+Math.round(((0.25 * vAlue) / 25.40)*rimPlace)/rimPlace+' in\n'+
' ='+Math.round((0.25 * vAlue)*rimPlace)/rimPlace+' mm\n'+
' ='+Math.round(((0.25 * vAlue) * Dpc / 10)*rimPlace)/rimPlace+' px/'+Dpi+'dpi\n';
		;break;
	case	'pt':
RESULT=vAlue + 'pt:\n'+
' ='+Math.round( (((vAlue / 72) * 25.40) * 4)*rimPlace)/rimPlace +' Q\n'+
' ='+Math.round( vAlue*rimPlace)/rimPlace + ' pt\n'+
' ='+Math.round( (vAlue / 72)*rimPlace)/rimPlace+' in\n'+
' ='+Math.round( ((vAlue / 72) * 25.40)*rimPlace)/rimPlace+' mm\n'+
' ='+Math.round( ((vAlue / 72) * Dpi )*rimPlace)/rimPlace+' px/'+Dpi+'dpi\n';
		;break;
	case	'in':
RESULT=vAlue + 'in:\n'+
' ='+Math.round( (vAlue * 25.40 * 4)*rimPlace)/rimPlace+' Q\n'+
' ='+Math.round( (vAlue * 72)*rimPlace)/rimPlace+' pt\n'+
' ='+Math.round( vAlue*rimPlace)/rimPlace + ' in\n'+
' ='+Math.round( (vAlue * 25.40*rimPlace)/rimPlace)+' mm\n'+
' ='+Math.round( (vAlue * Dpi)*rimPlace)/rimPlace+' px/'+Dpi+'dpi\n';
		;break;
	case	'mm':
RESULT=
vAlue+'mm:\n'+
' ='+Math.round((vAlue * 4)*rimPlace)/rimPlace+' Q\n'+
' ='+Math.round( ((vAlue / 25.40) * 72)*rimPlace)/rimPlace+' pt\n'+
' ='+Math.round( (vAlue / 25.40)*rimPlace)/rimPlace+ ' in\n'+
' ='+Math.round( vAlue*rimPlace)/rimPlace + ' mm\n'+
' ='+Math.round( (vAlue * Dpc / 10)*rimPlace)/rimPlace+' px/'+Dpi+'dpi\n';
		;break;
	case	'px':
RESULT=
vAlue + 'px/'+Dpi+' dpi:\n'+
' ='+Math.round( (vAlue / Dpc * 10) * 4 *rimPlace)/rimPlace+' Q\n'+
' ='+Math.round((((vAlue / Dpc * 10) / 25.40) * 72)*rimPlace)/rimPlace+' pt\n'+
' ='+Math.round( ((vAlue / Dpc * 10) / 25.40)*rimPlace)/rimPlace+' in\n'+
' ='+Math.round((vAlue / Dpc * 10)*rimPlace)/rimPlace+' mm\n'+
' ='+Math.round( vAlue*rimPlace)/rimPlace+' px/'+Dpi+'dpi\n';
		;break;
	}
	document.nasCALC.CONS.value='';
	putsCONS(RESULT);
}

/*
UI関連処理
*/
//データ初期化
//コンソールウインドウのデータ
var UImode=new Array();
	UImode["cons"]=0;//コンソール状態変数=kbd+1
	UImode["tbx"]=0;
	UImode["mdp"]=0;
	UImode["kbd"]=3;//キーボード状態変数=fkb+nkb*2
	UImode["fkb"]=0;
	UImode["nkb"]=0;
var UIdata=new Array();
//
UIdata["console00"] = '	<!-- コンソール表示 hide-->'+
'<input type=hidden'+
'	name=CONS'+
' /><input type=hidden'+
'	name=RESULT'+
' />'+
'	<!-- コンソール表示 hide-->';
//
UIdata["console01"] = '	<!-- コンソール表示 1-->'+
'<textarea'+
'	name=CONS'+
'	type="text"'+
'	rows="6" cols="20"'+
'	style="'+
'		font-size:11pt;'+
'		width:200px;'+
'		;'+
'	"'+
'></textarea><input type=hidden	name=RESULT value="" />'+
'	<!-- コンソール表示 -->';
//
UIdata["console02"] = '	<!-- コンソール表示 2-->'+
'<textarea'+
'	name=CONS'+
'	type="text"'+
'	rows="6" cols="20"'+
'	style="'+
'		font-size:11pt;'+
'		width:200px;'+
'		;'+
'	"'+
'></textarea><br /><textarea'+
'	name=RESULT'+
'	type="text"'+
'	rows="2" cols="20"'+
'	style="'+
'		font-size:11pt;'+
'		width:200px;'+
'		;'+
'	"'+
'></textarea><br /><INPUT type=button'+
'	name =clearCONS'+
'	value="CLEAR"'+
'	onClick="document.nasCALC.CONS.value=\'\';document.nasCALC.RESULT.value=\'\';"'+
'	style="width:4EM;padding:0 0"'+
'><input type="button"'+
'	name="check"'+
'	value="CHECK"'+
'	onclick="pushKey(this.name)"'+
'	style="width:4EM;padding:0 0"'+
'>'+
'	<!-- コンソール表示 -->';
//
UIdata["console03"] = '	<!-- コンソール表示 3-->'+
'<textarea'+
'	name=CONS'+
'	rows="10" cols="20"'+
'	style="'+
'		font-size:11pt;'+
'		width:200px;'+
'		;'+
'	"'+
'></textarea><br /><textarea'+
'	name=RESULT'+
'	rows="4" cols="20"'+
'	style="'+
'		font-size:11pt;'+
'		width:200px;'+
'		;'+
'	"'+
'></textarea><br /><INPUT type=button'+
'	name =clearCONS'+
'	value="CLEAR"'+
'	onClick="document.nasCALC.CONS.value=\'\';document.nasCALC.RESULT.value=\'\';"'+
'	style="width:4EM;padding:0 0"'+
'><input type="button"'+
'	name="check"'+
'	value="CHECK"'+
'	onclick="pushKey(this.name)"'+
'	style="width:4EM;padding:0 0"'+
'>'+
'	<!-- コンソール表示 -->';
//
UIdata["console04"] = '	<!-- コンソール表示 4-->'+
'<textarea'+
'	name=CONS'+
'	rows="12" cols="20"'+
'	style="'+
'		font-size:11pt;'+
'		width:200px;'+
'		;'+
'	"'+
'></textarea><br /><textarea'+
'	name=RESULT'+
'	rows="8" cols="20"'+
'	style="'+
'		font-size:11pt;'+
'		width:200px;'+
'		;'+
'	"'+
'></textarea><br /><INPUT type=button'+
'	name =clearCONS'+
'	value="CLEAR"'+
'	onClick="document.nasCALC.CONS.value=\'\';document.nasCALC.RESULT.value=\'\';"'+
'	style="width:4EM;padding:0 0"'+
'><input type="button"'+
'	name="check"'+
'	value="CHECK"'+
'	onclick="pushKey(this.name)"'+
'	style="width:4EM;padding:0 0"'+
'>'+
'	<!-- コンソール表示 -->';
//
UIdata["toolBox00"] = '	<!-- ツールボックスパネル hide-->'+
'<input	type=hidden'+
'	value="cons"'+
'	name="Pn1"'+
'	><br />'+
'<input	type=hidden'+
'	value="kbd"'+
'	name="Pn2"'+
'	><br />'+
'<input	type=hidden'+
'	value="kbd2"'+
'	name="Pn3"'+
'	><br />'+
'	<!-- ツールボックスパネル hidden-->';
//
UIdata["toolBox01"] = '	<!-- ツールボックスパネル 01-->'+
'<input	type=button'+
'	value="<->"'+
'	name="cons_bt"'+
'	NOTE="コンソール"'+
'	style="	font-size:8pt;'+
'		background-color:#AAAAAA;'+
'		padding:0 0;'+
'		margin:0 0'+
'	"'+
'	onMouseDown="kb_Flip(\'cons\')"'+
'	><br />'+
'<input	type=button'+
'	value="KBD"'+
'	name="kbd_bt"'+
'	ALT="キーボード切り換え"'+
'	style="	font-size:8pt;'+
'		background-color:#AAAAAA;'+
'		padding:0 0;'+
'		margin:0 0'+
'	"'+
'	onMouseDown="kb_Flip(\'kbd\')"'+
'	><br />'+
'<input	type=button'+
'	value="FIT"'+
'	name="fitting"'+
'	ALT="ウィンドウを合わせる"'+
'	style="	font-size:8pt;'+
'		background-color:#AAAAAA;'+
'		padding:0 0;'+
'		margin:0 0'+
'	"'+
'	onMouseDown="nas_sizeToContent();"'+
'	><br />'+
'<input	type=button'+
'	value="exp."'+
'	name="sbeval"'+
'	ALT="エクスプレッション"'+
'	style="	font-size:8pt;'+
'		background-color:#AAAAAA;'+
'		padding:0 0;'+
'		margin:0 0'+
'	"'+
'	onMouseDown="document.nasCALC.INbuf.value=eval(document.nasCALC.SIbuf.value);"'+
'	>'+
'	<!-- ツールボックスパネル 01-->';
//
UIdata["mdp00"]='	<!-- メインパネル -->'+
'<img src="./images/01.gif"'+
'	name="CHG"'+
'	id="CHG"'+
'	type="button"'+
'	ALT="キーボードモード切り換え"'+
'	onMouseDown = "nas_ChangeKBD()"'+
'	style="	width:16px;'+
'		height:16px;'+
'		text-align:center;'+
'		font-size:x-small;'+
'		background-color:#113311;'+
'		border-style:none;color:#22EE22'+
'	"'+
'/><img src="./images/05.gif"'+
'	name="CHG_clock"'+
'	id="CHG_clock"'+
'	type="button"'+
'	ALT="時刻表示切り換え"'+
'	onMouseDown = "nas_ChangeMODE()"'+
'	style="	width:16px;'+
'		height:16px;'+
'		text-align:center;'+
'		font-size:x-small;'+
'		background-color:#113311;'+
'		border-style:none;'+
'		color:#22EE22'+
'	"'+
'/><input type="button"'+
'	name="nas_RATE"'+
'	value="24FPS"'+
'	onclick = "nas_ChangeRATE(\'next\')"'+
'	style="	text-align:center;'+
'		font-family:Times;'+
'		font-size:9pt;'+
'		width:48px;'+
'		height:16px;'+
'		background-color:#113311;'+
'		color:#22EE22;'+
'		margin:0;'+
'		border-style:none;'+
'		padding:0'+
'	"'+
'	ALT="フレームレート切り換え"'+
'><input type="button"'+
'	name="Resolution"'+
'	value="144dpi"'+
'	onclick="chgResolution(inBuf)"'+
'	style="	text-align:center;'+
'		font-family:Times;'+
'		font-size:9pt;'+
'		width:42px;'+
'		height:16px;'+
'		background-color:#113311;'+
'		border-style:none;'+
'		color:#22EE22;'+
'		margin:0;'+
'		padding:0'+
'	"'+
'	ALT="解像度を入力してクリック"'+
'><input type="button"'+
'	name="inputMode"'+
'	value="10"'+
'	onclick="chgINPUTmode(\'next\')"'+
'	style="	text-align:center;'+
'		font-family:Times;'+
'		font-size:9pt;'+
'		width:24px;'+
'		height:16px;'+
'		background-color:#113311;'+
'		border-style:none;'+
'		color:#22EE22;'+
'		margin:0;'+
'		padding:0"'+
'	ALT="電卓の入力モードを切り換え"'+
'><input type="text"'+
'	style="	text-align:center;'+
'		font-family:Times;'+
'		font-size:6pt;'+
'		width:74px;'+
'		height:16px;'+
'		text-align:center;'+
'		background-color:#113311;'+
'		border-style:none;'+
'		color:#22EE22;'+
'		padding:0 0"'+
'	name="nas_Ri"'+
'	ALT="ランニングインジケータ"'+
'	value=""'+
'	onMouseDown="nas_Capt(\'Lap_Reset\')"'+
'><br /'+
'><input type="text"'+
'	 size=7'+
'	style="	width:50px;'+
'		text-align:center;'+
'		font-size:9pt;'+
'		background-color:#113311;'+
'		border-style:none;'+
'		color:#22EE22'+
'	"'+
'	name="sTatus"'+
'	NOTE="ストップウオッチの状態を示す"'+
'	value="startup"'+
'><input	type="text"'+
'	size=10'+
'	style="	width:170px;'+
'		font-size:14pt;'+
'		text-align:center;'+
'		background-color:#113311;'+
'		border-style:none;'+
'		color:#22EE22"'+
'	name="nas_display"'+
'	NOTE="ストップウオッチ表示部分"'+
'	value="00:00:00:00"'+
'	onMouseDown="nas_Capt(\'Start_Stop\')"'+
'><br /'+
'><input type="text"'+
'	name="COMbuf"'+
'	NOTE="コマンドディスプレイ"'+
'	size="1"'+
'	value=""'+
'	style="	width:40px;'+
'		font-size:9pt;'+
'		text-align:center;'+
'		background-color:#113311;'+
'		border-style:none;'+
'		color:#22EE22'+
'	"'+
'	onFocus="key_off=1;"'+
'	onBlur="key_off=0;"'+
'><input type="text"'+
'	name="INbuf"'+
'	NOTE="mainDisplay"'+
'	size="16"'+
'	value="0"'+
'	style="	width:180px;'+
'		font-size:14pt;'+
'		text-align:right;'+
'		background-color:#113311;'+
'		border-style:none;'+
'		color:#22EE22'+
'	"'+
'	onFocus="key_off=1;"'+
'	onBlur="key_off=0;"'+
'	onChange="checkINbuf();"'+
'><br /'+
'><input type="text"'+
'	name="SIbuf"'+
'	NOTE="subDisplay"'+
'	size="20"'+
'	value="0"'+
'	style="	width:220px;'+
'		font-size:12pt;'+
'		text-align: right;'+
'		background-color:#113311;'+
'		border-style:none;'+
'		color:#22EE22'+
'	"'+
'	onFocus="key_off=1;"'+
'	onBlur="key_off=0;"'+
'>'+
'	<!-- メインパネル -->';
//
UIdata["fkb00"]='	<!-- ファンクションキーボード hide-->'+
'<input type="hidden" value="dec">'+
'	<!-- ファンクションキーボード -->';
//
UIdata["fkb01"]='	<!-- ファンクションキーボード -->'+
'<input type="button" '+
'	name="SWButton"'+
'	NOTE="スイッチ"'+
'	value="・Start / Stop・"'+
'	style="width:8EM;background-color:#FFAAAA;padding:0 0"'+
'	onMouseDown="nas_Capt(\'Start_Stop\')"'+
'><input type="button"'+
'	name="LapButton"'+
'	NOTE="ラップ・リセット スイッチ"'+
'	value="・Lap / Reset・"'+
'	style="width:8EM;background-color:#AAFFAA;padding:0 0"'+
'	onMouseDown="nas_Capt(\'Lap_Reset\')"'+
'><br />'+
'<select NAME=inputModeSelector onChange="chgINPUTmode(this.value)"'+
' style="width:4EM;text-align:center;font-size:9pt;"'+
'>'+
'	<option VALUE=dec selected>dec'+
'	<option VALUE=bin >	bin'+
'	<option VALUE=oct >	oct'+
'	<option VALUE=hex >	hex'+
'	<option VALUE=fct >	TC'+
'</select>'+
'<input type="button"'+
'	name="dup"'+
'	value="DUP"'+
'	onclick="pushKey(this.name)"'+
'>'+
'<input type="button"'+
'	name="pop"'+
'	value="POP"'+
'	onclick="pushKey(this.name)"'+
'>'+
'<input type="button"'+
'	name="exc"'+
'	value="EXC"'+
'	onclick="pushKey(this.name)"'+
'>'+
'<br /><input type="button"'+
'	name="backspace"'+
'	style="background-color:#DDDDFF;padding-left:14;padding-right:14"'+
'	value="BS"'+
'	onclick="pushKey(\'BS\')"'+
'><input type="button"'+
'	style="background-color:#DDFFDD;padding-left:14;padding-right:14"'+
'	name="clearentry"'+
'	value="CE"'+
'	onclick="pushKey(\'CE\')"'+
'><input type="button"'+
'	style="background-color:#FFDDDD;padding-left:14;padding-right:14"'+
'	name="allclear"'+
'	value="AC"'+
'	onclick="pushKey(\'AC\')"'+
'><br /><input type="button"'+
'	name="Q"'+
'	value="Q"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="qpimp(operandStack.top(),\'Q\');"'+
'><input type="button"'+
'	name="point"'+
'	value="pt"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="qpimp(operandStack.top(),\'pt\')"'+
'><input type="button"'+
'	name="inch"'+
'	value="in"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="qpimp(operandStack.top(),\'in\')"'+
'><input type="button"'+
'	name="mm"'+
'	value="mm"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="qpimp(operandStack.top(),\'mm\')"'+
'><input type="button"'+
'	name="pixel"'+
'	value="px"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="qpimp(operandStack.top(),\'px\')"'+
'>'+
'	<!-- ファンクションキーボード -->';
//
UIdata["nkb00"]='	<!-- 数値キーボード hide-->';
//
//
UIdata["nkb01"]='	<!-- 数値キーボード -->'+
'<table border=0 cellpadding=0 cellspacing=0 align=center><tbody>'+
'<tr><td><input type="button"'+
'	name="toggle"'+
'	value="±"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(\'T\')"'+
'></td><td><input type="button"'+
'	name="pi"'+
'	value="π"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(\'P\')"'+
'></td><td><input type="button"'+
'	name="sqrt"'+
'	value="√"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(\'R\')"'+
'></td><td><input type="button"'+
'	name="div"'+
'	value="÷"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(\'/\')"'+
'></td><td><input type="button"'+
'	name="mod"'+
'	value="MOD"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(\'MOD\')"'+
'></td><td><br></td></tr>'+
''+
'<tr><td><input type="button"'+
'	name="D"'+
'	value="D"'+
'	style="font-size: 9pt;background-color:#E0E0E0"'+
'	onclick="pushKey(this.value)"'+
'></td><td><input type="button"'+
'	name="voidy"'+
'	value="E"'+
'	style="font-size: 9pt;background-color:#E0E0E0"'+
'	onclick="pushKey(this.value)"'+
'></td><td><input type="button"'+
'	name="voidy"'+
'	value="F"'+
'	style="font-size: 9pt;background-color:#E0E0E0"'+
'	onclick="pushKey(this.value)"'+
'></td><td><input type="button"'+
'	name="voidy"'+
'	value="×"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(\'*\')"'+
'></td><td><input type="button"'+
'	name="pow"'+
'	value="＾"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(\'^\')"'+
'></td><td><br></td></tr>'+
''+
'<tr><td><input type="button"'+
'	name="A"'+
'	value="A"'+
'	style="font-size: 9pt;background-color:#E0E0E0"'+
'	onclick="pushKey(this.name)"'+
'></td><td><input type="button"'+
'	name="B"'+
'	value="B"'+
'	style="font-size: 9pt;background-color:#E0E0E0"'+
'	onclick="pushKey(this.name)"'+
'></td><td><input type="button"'+
'	name="C"'+
'	value="C"'+
'	style="font-size: 9pt;background-color:#E0E0E0"'+
'	onclick="pushKey(this.name)"'+
'></td><td><input type="button"'+
'	name="minus"'+
'	value="−"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(\'-\')"'+
'></td><td><input type="button"'+
'	name="frame"'+
'	value=" "'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(this.name)"'+
'></td><td><br></td></tr>'+
''+
'<tr><td><input type="button"'+
'	name="7"'+
'	value="7"'+
'	style="font-size: 9pt;background-color:#C0C0C0"'+
'	onclick="pushKey(this.name)"'+
'></td><td><input type="button"'+
'	name="8"'+
'	value="8"'+
'	style="font-size: 9pt;background-color:#C0C0C0"'+
'	onclick="pushKey(this.name)"'+
'></td><td><input type="button"'+
'	name="9"'+
'	value="9"'+
'	style="font-size: 9pt;background-color:#C0C0C0"'+
'	onclick="pushKey(this.name)"'+
'></td><td rowspan=2><input type="button"'+
'	name="plus"'+
'	value="＋"'+
'	style="font-size: 9pt;background-color:#FFFFFF;padding-top:12;padding-bottom:12"'+
'	onclick="pushKey(\'+\')"'+
'></td><td><input type="button"'+
'	name="underbar"'+
'	value=" "'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(\'_\')"'+
'></td><td><br></td></tr>'+
''+
'<tr><td><input type="button"'+
'	name="4"'+
'	value="4"'+
'	style="font-size: 9pt;background-color:#C0C0C0"'+
'	onclick="pushKey(this.value)"'+
'></td><td><input type="button"'+
'	name="5"'+
'	value="5"'+
'	style="font-size: 9pt;background-color:#C0C0C0"'+
'	onclick="pushKey(this.value)"'+
'></td><td><input type="button"'+
'	name="6"'+
'	value="6"'+
'	style="font-size: 9pt;background-color:#C0C0C0"'+
'	onclick="pushKey(this.value)"'+
'></td><td><input type="button"'+
'	name="colon"'+
'	value=" "'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(\':\')"'+
'></td><td><br></td></tr>'+
''+
'<tr><td><input type="button"'+
'	name="1"'+
'	value="1"'+
'	style="font-size: 9pt;background-color:#C0C0C0"'+
'	onclick="pushKey(this.value)"'+
'></td><td><input type="button"'+
'	name="2"'+
'	value="2"'+
'	style="font-size: 9pt;background-color:#C0C0C0"'+
'	onclick="pushKey(this.value)"'+
'></td><td><input type="button"'+
'	name="3"'+
'	value="3"'+
'	style="font-size: 9pt;background-color:#C0C0C0"'+
'	onclick="pushKey(this.value)"'+
'></td><td ROWSPAN=2><input type="button"'+
'	name="equal"'+
'	value="＝"'+
'	style="font-size: 9pt;background-color:#FFFFFF;padding-top:12;padding-bottom:12"'+
'	onclick="pushKey(\'=\')"'+
'></td><td><input type="button"'+
'	name="semicolon"'+
'	value=" "'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(\';\')"'+
'></td><td><br></td></tr>'+
''+
'<tr><td colspan=2><input type="button"'+
'	name="zero"'+
'	value="0"'+
'	style="width:6EM;font-size: 9pt;background-color:#C0C0C0;padding-left:24;padding-right:24"'+
'	onclick="pushKey(\'0\')"'+
'></td><td><input type="button"'+
'	name="dot"'+
'	value="．"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(\'.\')"'+
'></td><td><input type="button"'+
'	name="comma"'+
'	value=" "'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(\',\')"'+
'></td><td><br></td></tr>'+
''+
'<tr><td><input type="button"'+
'	name="hour"'+
'	value=" "'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(this.value)"'+
'></td><td><input type="button"'+
'	name="page"'+
'	value=" "'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(this.value)"'+
'></td><td><input type="button"'+
'	name="minute"'+
'	value=" "'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="pushKey(this.value)"'+
'></td><td><input type="button"'+
'	name="about"'+
'	value="about"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="about_nas()"'+
'></td><td><input type="button"'+
'	name="log"'+
'	value="log"'+
'	style="font-size: 9pt;background-color:#FFFFFF"'+
'	onclick="nas_write_Log()"'+
'></td><td><br></td></tr>'+
''+
''+
'</tbody></table>'+
'	<!-- 数値キーボード -->';
//


//サブウィンドウのフリップ
function kb_Flip(aRgs) {
	switch(aRgs){
case 'cons':
	if(UImode["cons"]>0){
		UImode["cons"]=0
	}else{
		UImode["cons"]=UImode["fkb"]+UImode["nkb"]*2+1
	}
	document.getElementById('consoleBox').innerHTML=
	UIdata['console0'+UImode["cons"]];
	break;
case 'fkb':
	UImode["fkb"]=(UImode["fkb"] + 1)%2;
	document.getElementById('fkbBox').innerHTML=
	UIdata['fkb0'+UImode["fkb"]];
	if(UImode["cons"]>0){
		UImode["cons"]=UImode["fkb"]+UImode["nkb"]*2+1
		document.getElementById('consoleBox').innerHTML=
		UIdata['console0'+UImode["cons"]];
	}
	break;
case 'nkb':
	UImode["nkb"]=(UImode["nkb"] + 1)%2;
	document.getElementById('nkbBox').innerHTML=
	UIdata['nkb0'+UImode["nkb"]];
	if(UImode["cons"]>0){
		UImode["cons"]=UImode["fkb"]+UImode["nkb"]*2+1;
		document.getElementById('consoleBox').innerHTML=
		UIdata['console0'+UImode["cons"]];
	}
	break;
case 'kbd':
	UImode["kbd"]=(UImode["kbd"] + 1)%4;

	UImode["nkb"]=((UImode["kbd"]+UImode["kbd"]%2)/2)%2;
	UImode["fkb"]=(((UImode["kbd"]+1)+(UImode["kbd"]+1)%2)/2)%2;

	document.getElementById('fkbBox').innerHTML=
	UIdata['fkb0'+UImode["fkb"]];
	document.getElementById('nkbBox').innerHTML=
	UIdata['nkb0'+UImode["nkb"]];
	if(UImode["cons"]>0){
		UImode["cons"]=UImode["fkb"]+UImode["nkb"]*2+1;
		document.getElementById('consoleBox').innerHTML=
		UIdata['console0'+UImode["cons"]];
	}
	break;
default	:	alert(aRgs);
	}
var autoFit=1;
if (autoFit) {setTimeout("nas_sizeToContent()",50)}
}
/*ウインドウをコンテンツにフィットさせる関数、引数は特になし*/
function nas_sizeToContent(){
	if(ckUA()[1]!='MSIE'){
//モジラ系の場合は、sizeToContent()を呼ぶだけ。
	try{sizeToContent();}catch(e){return;
	//alert(e);
	}
	}else{
//IE系の場合は大雑把にマッチ
//このプロパティはinnerWidth/Height と等価だった
	try{
	var WinW=document.getElementById("uiTable").clientWidth+60;
	var WinH=document.getElementById("uiTable").clientHeight+120;
	window.resizeTo(WinW,WinH);
	}catch(e){return;
	alert(e);}
	}
}

/*
ストップウオッチフォームが読み込まれた直後に呼び出されて、
ストップウオッチを最終的に開始させる関数。
フォーム上のカスタム変数の読み込み(オーバーライド)および
表示インターバルの開始
明示的な終了手続きは特になし。
*/
function nas_Action_Startup() {
//ブラウザの判定をしてあまりに古い場合は終了コメントをだす。
/*			*/

	if (! ckUA()[0]) {
	document.getElementById('mdpBox').innerHTML='<b>'+
'申し訳ありませんが、現在ご使用のブラウザには対応しておりません。<br />'+
'MSIE5.5 以降、Netscape6 以降 またはこれらに相当の実行環境でご使用お願いします。<br />'+
'どうしても現在のブラウザでご使用になりたい場合は、<A href="mailto:nekomata_ya@mac.com">「ねこまたや」</A>まで<br />'+
'ご連絡くだるか、<A href="http://homepage2.nifty.com/Nekomata/bbs.html" target=_new>このあたり</A>でリクエストしてみてください。<br />状況次第ではなんとかなるかもしれません…ならんかもしれませんが…<br />'+
'<br />'+ckUA()+'<br /><hr />'
'2005/Nekomataya/kiyo';
return;	}

	document.getElementById('mdpBox').innerHTML=UIdata['mdp00'];
	document.nasCALC.sTatus.value= "startup";
	if( navigator.appName == "Netscape" ) {document.captureEvents( Event.MOUSEDOUN )}
//フォーム上のカスタム変数を読み取る
	pastrate = RATE; 	//新レートを設定する前に元のレートを退避
		nas_ChangeRATE( document.nasCALC.RATE.value );
	MaxLap = document.nasCALC.MaxLap.value;
	ClockOption = document.nasCALC.ClockOption.value;
	nas_ChangeMODE(MODE);
	nas_ChangeKBD(KeyMODE);
	chgINPUTmode('dec');
	initRi(document.nasCALC.nas_Ri_base.value);
	document.nasCALC.nas_Ri.value = running
//	再初期化終了・動作開始
	nas_cc2dp();
//	nas_Clear_LAP();
	document.nasCALC.sTatus.value = "ready";
	m_action = true;
	CaptureAction = "";
//	表示インターバル開始
		Action = setInterval("nas_update_View()",10);
// ウィンドウのツールバー類を非表示に
	if(false){
		statusbar.visible=false;
		toolbar.visible=false;
		menubar.visible=false;
		directories.visible=false;
		locationbar.visible=false;
		personalbar.visible=false;
	}
//	ウィンドウをリサイズ?
		setTimeout("nas_sizeToContent();",50);
//	お後がよろしいようで
}
// プログラムおしまい とっぴんぱらりのぷぅ
// -->
</script>
<!--
input { background-color: #EFEFEF;border-width:2;margin:0;padding:2;border-style:outset}
input {font-size:9pt;border-width:1}
-->
<style TYPE="text/css">
<!--
body {text-align:left;color:black;background:#EFEFEF;font-size:9pt;margin:0 12 8 0;padding:0}
A:link    {color:#0000C0;text-decoration:none;}
A:visited {color:#8000D0;text-decoration:none;}
A:active  {color:blue;text-decoration:none;}
A:hover  {color:#000080;background-color:#fafad2;}
INPUT {
	width:36px;
	background-color: #FEFEFE;
	border-width:2;
	border-style:solid;
	border-color:#D3D3D3;
	margin:1;
	padding-right:10;padding-left:10;
}
-->
</style>
</head>
<body
onLoad		= "nas_Action_Startup()"
onMouseDown	= "nas_Mouse(event.which,event.target)"
onMouseUp	= "return false"
onContextMenu	= "if (KeyMODE == 'stopwatch') return false"
>
<!--
公開試験中<br />
気が向いたヒトつかってみてください。ツッコミ歓迎<br />
デザインは暫定版でえす。<br />
もっと小さいほうが良いとは思いますがフツーのフォーム部品で作っているのでとりあえずこんなカンジ。<br />
機能とかもう少し決まったら変更します。<br />
デザインのアイデアとかも希望があれば行ってみて下さい。<br />
今の仕事が一区切りついたらこの電卓に「りまぴん」機能を組み込もうかと…<br />
ご意見、ご感想は<A HREF="http://homepage2.nifty.com/Nekomata/bbs.html" target=_new>BBS</A>まで<br />
<HR>-->
	<!-- この下本体 -->


<form name="nasCALC" >
<!--
カスタム変数です。ここを書き換えると初期状態が変わります。
ブラウザには表示されません。値のみを書き換えてください。
-->
<!-- 時計の表示モードです。12時制か24時制を指定します。-->
	<input type="hidden" name="ClockOption" value="12">
<!-- オープン時点の表示モード ストップウオッチ(stopwatch)か電卓(calculator)か -->
	<input type="hidden" name="MODE" value="calculator">
<!--ラップの最大数です。ラップ欄と数を合わせておいて下さい。-->
	<input type="hidden" name="MaxLap" value="4">
<!-- ランニングインジケータ
何か２６文字置いてください。
縦棒を隙間に挿入して２４コマのアニメーションを作ります。-->
<input type="hidden" name="nas_Ri_base" value="|........................|">
<!--初期　計測フレームレートです。-->
	<input type="hidden" name="RATE" value="24FPS">
<!--
設定できる値は以下の通りです、アルファベットは大文字のみで、
リストにない値を与えると100分の1秒になります。
24FPS	1秒あたり24フレーム(=デフォルト)
25FPS	1秒あたり15フレーム
30NDF	1秒あたり30フレーム(ノンドロップ)
30DF	1秒あたり30フレーム(ドロップ)
100fps	100分の1秒
(数字)	1-100までの任意の数字(整数のみ)
-->
<!--フォーム内のオブジェクトの名前には意味があります。-->
<table	id=uiTable
	border="1"
	cellpadding="0"
	cellspacing="0"
	style="
		text-align:left;
		background-color:#808080
	"
	onKeyDown	= "return false"
>

<tbody><tr><td
	nowrap
	valign=top
	style="	width:240px;
		text-align:center;
		background-color:#113311
	"
>
<div	id=mdpBox
	style="	margin:2;
		text-align:center;
		font-size:x-small;
		background-color:#113311;
		border-style:none;
		color:#22EE22
	"
>
	<!-- メインパネル -->
<b>ねこまたや・電卓</b><br />
<br />このコンテンツは、Javascriptで書かれたアプリケーションです。<br />
ご利用の際は、Javascriptを有効にしてお使いください。
<br /><br />


<input type="hidden"
	name="nas_RATE"
	value="24FPS"
	title="フレームレート切り換え"
><input type="hidden"
	name="Resolution"
	value="144dpi"
	title="解像度を入力してクリック"
><input type="hidden"
	name="inputMode"
	value="10"
	title="電卓の入力モードを切り換え"
><input type="hidden"
	name="nas_Ri"
	NOTE="ランニングインジケータ"
	value=""
><input type="hidden"
	name="sTatus"
	NOTE="ストップウオッチの状態を示す"
	value="startup"
><input	type="hidden"
	name="nas_display"
	NOTE="ストップウオッチ表示部分"
	value="00:00:00:00"
><input type="hidden"
	name="COMbuf"
	NOTE="コマンドディスプレイ"
	value=""
><input type="hidden"
	name="INbuf"
	NOTE="mainDisplay"
	value="0"
><input type="hidden"
	name="SIbuf"
	NOTE="subDisplay"
	value="0"
>
	<!-- メインパネル -->


</div>
<div
	id="fkbBox"
	style="
		margin:2;
		text-align:center;
		font-size:x-small;
		background-color:#993311;
		border-style:none;
		color:#22EE22"
>
	<!-- ファンクションキーボード -->
<input type=hidden name=inputModeSelector value="dec">

	<!-- ファンクションキーボード -->
</div><div
	id="nkbBox"
	style="
		margin:2;
		text-align:center;
		font-size:x-small;
		background-color:#888888;
		border-style:none;
		color:#22EE22"
>	<!-- 数値キーボード 挿入位置--></div>
</td><td	valign=top>
<div	name="tooPanel"
>
	<!-- ツールボックスパネル 挿入位置 -->
<script>
<!--
document.write(UIdata["toolBox01"]);
// -->
</script>
</div>
</td><td	valign=top >
<div	id=consoleBox >
	<!-- コンソール表示 挿入位置-->
<input type=hidden name=CONS  />
<input type=hidden name=RESULT />

</div>
</td><td	valign=top>
<div	id=rimaPing>
	<!-- りまぴんmini挿入位置 -->

</td></tr>
</tbody></table></form>
<!--

<textarea
	name=_MEMO
	rows="10" cols="80"
	style="font-size:11pt"
>
2004.09.12<br />
一応電卓、作り始め 何とか電卓らしくなってきた。<br />
時計はまだ組み込んでない。<br />
既成のストップウオッチを組み込むヨテー<br />
タイムコードの計算機能もまだ。<br />
<br />
でんでろりん<br />
時計とストップウオッチが合体！<br />
混ぜただけですが…<br />
<br />
2004.09.18<br />
game.gr.jpで見たライブラリを借用。<br />
なるほど、こんなふうにすると良いのね<br />
ああ、キーを拾う時はプレスの方が良いのか…な?<br />
プレスとダウンの時間差を計ってみましょう。今度ね<br />
2004.09.19<br />
ぎゅー ちょっとカゼ<br />
デザイン変えてみる<br />
そろそろつかえる感じか?<br />
<HR>
2004.09.23 TC計算コーディング開始<br />

実時間保持<br />
cc値でとりあえず開始<br />
9/26<br />
ダメみたい<br />
バッファ内部の値をcc値にすると乗算除算の際に入力バッファとスタックの値が変わるので、イヤ。<br />
とりあえずフレーム保持型に変更してみる。

10/15<br />
やれやれ、やっぱり昔作った奴と似そう。<br />
ま、よし
10/17
あまりゃ、
いまさらデータ形式で悩む。
文字列としてバッファを保持するのは正解だが、スタック自身を配列で持つのはいかが?
結構いけそうな気が…ただしいろいろ基本機能に手を入れないとできない様な気も…

05/01/17
3カ月ぶりに再開。何をしていたかよく思い出せない。
入力ルーチンだったかな?
うむ、こんな感じ
01/19
ブラウザ判定を書いた。組み込んでみる。
01/24
さいてーカモ
TCのサブルーチンを負の数に対応させるのをすっかり忘れていた。
さらに、追加分の関数が小数点以下の数値に対応していない。
TCの計算メチャクチャ…
なんとかちょぼっと直してみる。かなりヒドイ
</textarea>
-->
</body></html>